name: CI Pipeline

on:
    push:
        branches: [main, develop, feat/*, fix/*] # Run on pushes to these branches
    pull_request:
        branches: [main, develop] # Run on PRs to these branches

jobs:
    test:
        name: Run Tests
        runs-on: ubuntu-latest

        # Service containers for integration tests
        services:
            redis:
                image: redis:7-alpine
                ports:
                    - 6379:6379
                options: >-
                    --health-cmd "redis-cli ping"
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        strategy:
            matrix:
                node-version: [18.x, 20.x]

        steps:
            # Step 1: Checkout code
            - name: Checkout code
              uses: actions/checkout@v4

            # Step 2: Setup Node.js
            - name: Setup Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "npm"

            # Step 3: Install dependencies
            - name: Install dependencies
              run: npm ci

            # Step 4: Run linter
            - name: Run ESLint
              run: npm run lint

            # Step 5: Run tests
            - name: Run tests
              run: npm test
              env:
                  JWT_SECRET: ${{ secrets.JWT_SECRET || 'test-secret-key' }}
                  MONGO_URI: mongodb://localhost:27017/test-db
                  REDIS_HOST: localhost
                  REDIS_PORT: 6379

            - name: Generate coverage report
              run: npm test -- --coverage --watchAll=false
              env:
                  JWT_SECRET: ${{ secrets.JWT_SECRET || 'test-secret-key' }}
                  MONGO_URI: mongodb://localhost:27017/test-db
                  REDIS_HOST: localhost
                  REDIS_PORT: 6379

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v3
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
                  files: ./coverage/lcov.info
                  flags: unittests
                  fail_ci_if_error: false

    build:
        name: Build Check
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20.x"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build TypeScript
              run: npm run build
